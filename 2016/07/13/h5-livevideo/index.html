
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>移动端h5直播实战 | xj&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="背景最近直播又成为了风口。身处移动互联网行业，难免不趟这趟水。最近刚做完了公司直播h5端的功能。借此机会系统的了解和学习了一下直播相关的技术和方案。在完成功能的同时也遇到了不少问题，所以又简单地研究了一下“印客”和“花椒”的移动端方案，试图找到最好的解决方案。
HLS协议目前市面上流媒体协议有一大票：RTMP、RTSP、FLV、HLS、DASH等。私有的，开放的，标准化的，非标准化的都有。分别有各">
<meta property="og:type" content="article">
<meta property="og:title" content="移动端h5直播实战">
<meta property="og:url" content="http://xjcloudy.github.io/2016/07/13/h5-livevideo/index.html">
<meta property="og:site_name" content="xj's blog">
<meta property="og:description" content="背景最近直播又成为了风口。身处移动互联网行业，难免不趟这趟水。最近刚做完了公司直播h5端的功能。借此机会系统的了解和学习了一下直播相关的技术和方案。在完成功能的同时也遇到了不少问题，所以又简单地研究了一下“印客”和“花椒”的移动端方案，试图找到最好的解决方案。
HLS协议目前市面上流媒体协议有一大票：RTMP、RTSP、FLV、HLS、DASH等。私有的，开放的，标准化的，非标准化的都有。分别有各">
<meta property="og:image" content="http://xjcloudy.github.io/2016/07/13/h5-livevideo/HLS_TS.jpg">
<meta property="og:updated_time" content="2016-07-18T07:22:50.753Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="移动端h5直播实战">
<meta name="twitter:description" content="背景最近直播又成为了风口。身处移动互联网行业，难免不趟这趟水。最近刚做完了公司直播h5端的功能。借此机会系统的了解和学习了一下直播相关的技术和方案。在完成功能的同时也遇到了不少问题，所以又简单地研究了一下“印客”和“花椒”的移动端方案，试图找到最好的解决方案。
HLS协议目前市面上流媒体协议有一大票：RTMP、RTSP、FLV、HLS、DASH等。私有的，开放的，标准化的，非标准化的都有。分别有各">
<meta name="twitter:image" content="http://xjcloudy.github.io/2016/07/13/h5-livevideo/HLS_TS.jpg">
  
    <link rel="alternative" href="/atom.xml" title="xj&#39;s blog" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

</head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/myname"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">My Blog</a>
        </h1>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara">MyLogo</li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">Home</a>
      
        <a class="main-nav-link" href="/archives">Archives</a>
      
        <a class="main-nav-link" href="/about">About</a>
      
      <a class="main-nav-link st-search-show-outputs">Search</a>
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-h5-livevideo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2016/07/13/h5-livevideo/" class="article-date">
  <time datetime="2016-07-12T16:44:07.000Z" itemprop="datePublished">2016-07-13</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      移动端h5直播实战
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近直播又成为了风口。身处移动互联网行业，难免不趟这趟水。最近刚做完了公司直播h5端的功能。借此机会系统的了解和学习了一下直播相关的技术和方案。在完成功能的同时也遇到了不少问题，所以又简单地研究了一下“印客”和“花椒”的移动端方案，试图找到最好的解决方案。</p>
<h2 id="HLS协议"><a href="#HLS协议" class="headerlink" title="HLS协议"></a>HLS协议</h2><p>目前市面上流媒体协议有一大票：<code>RTMP</code>、<code>RTSP</code>、<code>FLV</code>、<code>HLS</code>、<code>DASH</code>等。私有的，开放的，标准化的，非标准化的都有。分别有各自的优缺点和适合的使用场景。各协议的细节我们不在这里讨论。大概提一下他们的实现思路大体一致。都是将视频源的流做分片，然后分发给客户端。客户端在本地拼接，然后播放。我们讨论的范围只局限在移动端H5。最适合的方案就是<code>HLS</code> 。</p>
<blockquote>
<p>HLS(HTTP Live Streaming)<br>  是由苹果公司提出的一个基于<strong>HTTP</strong>的流媒体网络传输协议。最初用于苹果的软件中。随后，被其他厂商接受。最重要的是 Android自3.0后也支持了<code>HLS</code>协议。目前苹果已将起提交至IETF。希望将其标准化。</p>
</blockquote>
<p>协议细节如下：<br> <img src="/2016/07/13/h5-livevideo/HLS_TS.jpg" alt="HLS_TS.jpg" title=""></p>
<ul>
<li>服务器端每次将采集到的视频文件。切成大小相等的若干“片”。叫做ts文件。并对其进行生成索引。</li>
<li>客户端轮询服务器。请求一个m3u8格式的文件。这个文件，实质上是一个播放列表。存放的是若干ts文件的uri地址。</li>
<li>客户端按照顺序下载通过请求m3u8文件而获得的ts文件。并按时间顺序进行拼接并完成播放。</li>
<li>m3u8格式目前的定义如下：<blockquote>
<p><code>#EXT-X-TARGETDURATION</code><br>   <em>定义每个TS的最大的duration。</em><br>  <code>#EXT-X-MEDIA-SEQUENCE</code><br>   <em>定义当前m3u8文件中第一个文件的序列号，每个ts文件在m3u8文件中都有固定唯一的序列号，该序列号用于在MBR时切换码率进行对齐。</em><br>  <code>#EXT-X-KEY</code><br>   <em>定义加密方式和key文件的url，用于取得16bytes的key文件解码ts文件。</em><br>   <code>#EXT-X-PROGRAM-DATE-TIME</code><br>   <em>第一个文件的绝对时间</em><br>  <code>#EXT-X-ALLOW-CACHE</code><br>   <em>是否允许cache。</em><br>  <code>#EXT-X-ENDLIST</code><br>   <em>表明m3u8文件的结束。live m3u8没有该tag。</em><br>  <code>#EXT-X-STREAM-INF</code><br>   <em>BANDWIDTH                指定码率<br>   PROGRAM-ID               唯一ID<br>   CODECS                   指定流的编码类型</em><br>  <code>#EXT-X-DISCONTINUITY</code><br>   <em>当遇到该tag的时候说明以下属性发生了变化:<br>   file format<br>   number and type of tracks<br>   encoding parameters<br>   encoding sequence<br>   timestamp sequence</em><br> <code>#EXT-X-VERSION</code><br>   <em>该属性用不用都可以，可以没有</em></p>
</blockquote>
</li>
</ul>
<p>HLS协议的优点：</p>
<ul>
<li>基于<strong>HTTP</strong>,易于实现。可以很方便的与现有的web业务逻辑整合。</li>
<li>HTTP天然的防火墙友好。</li>
<li>兼容性好。主流移动端系统都支持。移动端直接使用H5的<code>&lt;video&gt;</code>标签即可。</li>
</ul>
<p>HLS协议的缺点：</p>
<ul>
<li>实时性差，即延迟。服务端要先进行切片。客户端需要通过网络下载。这些都要耗费时间。另外m3u8中定义的切片时长越长。一次获取的分片数量越多。延迟就越严重。</li>
<li>m3u8只包含了视频信息。没有定义其他控制状态信息。所以客户端播放器除了下载视频文件播放外，无法做出其他的响应。因此客户端是<strong>单向</strong>，<strong>被动</strong>的。</li>
</ul>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>其实前端真没什么能做的，准备好dom结构，调调样式。在移动端，应为都用的<code>video</code>标签。如果要兼顾web端，就得和adobe那套打交道，弄个flash播放器。找找第三方的就好。比如“印客”用的是<a href="https://www.jwplayer.com" target="_blank" rel="external">jwplayer</a>的那套。<br>我们用的是腾讯视频云。腾讯提供了全套的解决方案。就说说用腾讯视频云的经验吧。</p>
<ul>
<li><p>腾讯提供了前端播放器的库。需要在页面单独引入。比较坑的是除了一个demo代码。没有提供文档。其行为不可控。 除非你有空，去扒他代码，做hack。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">new</span> qcVideo.Player(</div><div class="line">    <span class="string">"videolayer"</span>,                             <span class="comment">//容器</span></div><div class="line">    &#123;</div><div class="line">        <span class="string">'channel_id'</span>: liveChannelId,          <span class="comment">//旁路id</span></div><div class="line">        <span class="string">'app_id'</span>: appId,                      <span class="comment">//应用id</span></div><div class="line">        <span class="string">'width'</span>: nodes.videolayer.width(),    <span class="comment">//播放器宽度</span></div><div class="line">        <span class="string">'height'</span>: nodes.videolayer.height()   <span class="comment">//播放器高度</span></div><div class="line">    &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
</li>
<li><p>腾讯播放器自动引入的样式。有全局命名的。比如这个<strong>“.current”</strong> 。可能会和你页面现有同名样式发生冲突。需要额外留个心。</p>
</li>
<li>腾讯播放器的构造函数。中需要传入播放器的高宽值。还不能是相对值。所以像我这里是直接传入的是容器的高宽。但是移动端还要考虑屏幕旋转的问题。所以需要处理<code>orientationchange</code>事件。手动设置高宽。请自行体会。</li>
<li>目前版本的腾讯视频云sdk。旁路推流是不支持一开始推<strong><code>音频流</code></strong>的,如果中间视频切音频是可以的。</li>
<li>腾讯的播放器，会包含一些他自己的业务动作。<ul>
<li>获取播放地址：通过appId和channelId。获取播放地址。会在出错的时候弹窗提示（坑）。</li>
<li>系统检测：如果系统不具备播放能力，会有一段没样式的文字提示（坑）。</li>
<li>加密视频的弹窗：如果是加密视频。在播放前会展示个输入密码的弹窗。关键是这个不适配移动端。感觉不像是视频云的业务。这个播放器应该是拿的别的组的先用着的吧。</li>
</ul>
</li>
<li>单独说一下<strong>20301</strong>错误: 一开始经常会遇到播放器弹20310错误。这个是channelId不存在。往往是 推流端和后台配合的问题。没给到正确的channelId。</li>
<li><p>延迟。我们发现腾讯视频云的HLS延迟特别严重。到达30s以上。比较一下“印客”和腾讯视频云的m3u8文件。我们发现，腾讯视频云的<code>EXT-X-TARGETDURATION</code>是7，ts列表个数是5。而“印客”的<code>EXT-X-TARGETDURATION</code>是3，ts列表个数也是3。很显然腾讯视频云的延迟会达到7*5=35秒。而“印客”的是3*3=9秒。</p>
<ul>
<li><p>腾讯的m3u8文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#EXTM3U</div><div class="line">#EXT-X-VERSION:3</div><div class="line">#EXT-X-ALLOW-CACHE:NO</div><div class="line">#EXT-X-MEDIA-SEQUENCE:1468215779</div><div class="line">#EXT-X-TARGETDURATION:7</div><div class="line">#EXTINF:4.64, 2982_a0c28097472611e6a2cba4dcbef5e35a-1468215779.ts?cdncode=/18907E7BE0798990/&amp;buname=2982&amp;sdtfrom=v0&amp;vkey=</div><div class="line">#EXTINF:6.19, 2982_a0c28097472611e6a2cba4dcbef5e35a-1468215780.ts?cdncode=/18907E7BE0798990/&amp;buname=2982&amp;sdtfrom=v0&amp;vkey=</div><div class="line">#EXTINF:5.948, 2982_a0c28097472611e6a2cba4dcbef5e35a-1468215781.ts?cdncode=/18907E7BE0798990/&amp;buname=2982&amp;sdtfrom=v0&amp;vkey=</div><div class="line">#EXTINF:4.1, 2982_a0c28097472611e6a2cba4dcbef5e35a-1468215782.ts?cdncode=/18907E7BE0798990/&amp;buname=2982&amp;sdtfrom=v0&amp;vkey=</div><div class="line">#EXTINF:5.978, 2982_a0c28097472611e6a2cba4dcbef5e35a-1468215783.ts?cdncode=/18907E7BE0798990/&amp;buname=2982&amp;sdtfrom=v0&amp;vkey=</div></pre></td></tr></table></figure>
</li>
<li><p>印客的m3u8文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#EXTM3U</div><div class="line">#EXT-X-ALLOW-CACHE:NO</div><div class="line">#EXT-X-TARGETDURATION:3</div><div class="line">#EXT-X-MEDIA-SEQUENCE:742</div><div class="line">#EXTINF:3, 1214761.ts?wsApp=HLS&amp;wsMonitor=-1</div><div class="line">#EXTINF:3, 1214762.ts?wsApp=HLS&amp;wsMonitor=-1</div><div class="line">#EXTINF:3, 1214763.ts?wsApp=HLS&amp;wsMonitor=-1</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>ios还有某些android手机比如（小米，oppo）。系统会接管web中的播放行为。单独打开系统播放器来播放。所以产品说让做个什么 浮层 在视频上显示在线人数什么的。就果断拒绝吧。</p>
</li>
</ul>
<p>完！</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
        <a data-url="http://xjcloudy.github.io/2016/07/13/h5-livevideo/" data-id="ciqk8tdu30000vwej3jicoa3y" class="article-share-link">分享到</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/07/02/homework-jquery-select/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">前端作业[1]-50行代码实现简单的jquery选择器</div>
    </a>
  
</nav>

  
</article>


</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/07/13/h5-livevideo/">移动端h5直播实战</a>
          </li>
        
          <li>
            <a href="/2016/07/02/homework-jquery-select/">前端作业[1]-50行代码实现简单的jquery选择器</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Xj<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/sun11/hexo-theme-paperbox" target="_blank">Paperbox</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="返回顶部"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</div>
</body>
</html>
